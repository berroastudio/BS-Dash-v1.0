<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configuraci√≥n Microsoft 365 - BS Dash</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="../css/styles.css">
    <style>
        .status-badge {
            transition: all 0.3s ease;
        }
        .guide-step {
            border-left: 3px solid #3b82f6;
            padding-left: 1rem;
            margin-bottom: 1rem;
        }
        .config-card {
            transition: all 0.3s ease;
        }
        .config-card:hover {
            transform: translateY(-2px);
        }
    </style>
</head>
<body class="bg-[#fbfbfb] min-h-screen">
    <!-- Header Id√©ntico al Resto de M√≥dulos -->
    <header class="bs-card mx-4 mt-4 mb-6">
        <div class="flex items-center justify-between p-4">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-blue-100 rounded-xl flex items-center justify-center border border-blue-200">
                    <i class="bi bi-microsoft text-blue-600"></i>
                </div>
                <div>
                    <h1 class="text-xl font-bold text-gray-800">Configuraci√≥n Microsoft 365</h1>
                    <p class="text-sm text-gray-600">Integraci√≥n con Azure AD y servicios Microsoft</p>
                </div>
            </div>
            
            <div class="flex items-center gap-4">
                <a href="../dashboard.html" class="bs-btn bg-gray-100 text-gray-700 border-gray-300 hover:bg-gray-200">
                    <i class="bi bi-arrow-left"></i> Volver al Dashboard
                </a>
                <button onclick="probarTodasConexiones()" class="bs-btn bg-green-50 text-green-600 border-green-200 hover:bg-green-100">
                    <i class="bi bi-plug"></i> Probar Conexiones
                </button>
            </div>
        </div>
    </header>

    <main class="max-w-6xl mx-auto px-4">
        <!-- Estado del Sistema -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <div class="bs-stat-card p-4 text-center config-card">
                <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center mx-auto mb-2 border border-blue-200">
                    <i class="bi bi-cloud-arrow-up text-blue-600"></i>
                </div>
                <h3 class="font-semibold text-gray-800" id="estadoAzure">No Configurado</h3>
                <p class="text-sm text-gray-600">Azure AD</p>
                <div class="mt-2" id="azureStatusBadge">
                    <span class="px-2 py-1 text-xs rounded-full bg-gray-100 text-gray-800">Inactivo</span>
                </div>
            </div>
            
            <div class="bs-stat-card p-4 text-center config-card">
                <div class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center mx-auto mb-2 border border-green-200">
                    <i class="bi bi-database text-green-600"></i>
                </div>
                <h3 class="font-semibold text-gray-800" id="estadoCosmos">Local</h3>
                <p class="text-sm text-gray-600">Base de Datos</p>
                <div class="mt-2" id="cosmosStatusBadge">
                    <span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-800">Local Storage</span>
                </div>
            </div>
            
            <div class="bs-stat-card p-4 text-center config-card">
                <div class="w-12 h-12 bg-purple-100 rounded-xl flex items-center justify-center mx-auto mb-2 border border-purple-200">
                    <i class="bi bi-hdd-network text-purple-600"></i>
                </div>
                <h3 class="font-semibold text-gray-800" id="estadoHosting">Local</h3>
                <p class="text-sm text-gray-600">Hosting</p>
                <div class="mt-2" id="hostingStatusBadge">
                    <span class="px-2 py-1 text-xs rounded-full bg-gray-100 text-gray-800">Desarrollo</span>
                </div>
            </div>

            <div class="bs-stat-card p-4 text-center config-card">
                <div class="w-12 h-12 bg-orange-100 rounded-xl flex items-center justify-center mx-auto mb-2 border border-orange-200">
                    <i class="bi bi-shield-check text-orange-600"></i>
                </div>
                <h3 class="font-semibold text-gray-800" id="estadoSeguridad">B√°sica</h3>
                <p class="text-sm text-gray-600">Seguridad</p>
                <div class="mt-2" id="securityStatusBadge">
                    <span class="px-2 py-1 text-xs rounded-full bg-orange-100 text-orange-800">Local</span>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Panel de Configuraci√≥n Azure -->
            <div class="bs-card p-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                    <i class="bi bi-gear text-blue-600"></i>
                    Configuraci√≥n Azure AD
                </h2>

                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="bi bi-building"></i> Tenant ID
                        </label>
                        <input type="text" id="azureTenantId" class="bs-input w-full" 
                               placeholder="a1b2c3d4-e5f6-7890-abcd-ef1234567890"
                               onchange="validarConfiguracion()">
                        <p class="text-xs text-gray-500 mt-1">ID √∫nico de tu organizaci√≥n en Azure</p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="bi bi-app"></i> Client ID (Application ID)
                        </label>
                        <input type="text" id="azureClientId" class="bs-input w-full" 
                               placeholder="12345678-1234-1234-1234-123456789012"
                               onchange="validarConfiguracion()">
                        <p class="text-xs text-gray-500 mt-1">ID de la aplicaci√≥n registrada en Azure</p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="bi bi-key"></i> Client Secret
                        </label>
                        <input type="password" id="azureClientSecret" class="bs-input w-full" 
                               placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                               onchange="validarConfiguracion()">
                        <p class="text-xs text-gray-500 mt-1">Secreto de la aplicaci√≥n (v√°lido por 1-2 a√±os)</p>
                    </div>

                    <div class="flex gap-3 pt-4">
                        <button onclick="probarConexionAzure()" class="bs-btn bg-blue-50 text-blue-600 border-blue-200 hover:bg-blue-100 flex-1">
                            <i class="bi bi-plug"></i> Probar Conexi√≥n
                        </button>
                        <button onclick="guardarConfiguracionAzure()" class="bs-btn bs-btn-primary flex-1" id="btnGuardarConfig" disabled>
                            <i class="bi bi-check-lg"></i> Guardar Configuraci√≥n
                        </button>
                    </div>
                </div>
            </div>

            <!-- Gu√≠a de Configuraci√≥n -->
            <div class="bs-card p-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                    <i class="bi bi-journal-text text-green-600"></i>
                    Gu√≠a de Configuraci√≥n
                </h2>

                <div class="space-y-4">
                    <div class="guide-step">
                        <h3 class="font-semibold text-gray-800 mb-2">1. Ir al Azure Portal</h3>
                        <p class="text-sm text-gray-600 mb-2">Accede a <a href="https://portal.azure.com" target="_blank" class="text-blue-600 underline">portal.azure.com</a> con tu cuenta Microsoft 365 Business</p>
                    </div>

                    <div class="guide-step">
                        <h3 class="font-semibold text-gray-800 mb-2">2. Crear App Registration</h3>
                        <p class="text-sm text-gray-600 mb-2">En Azure Active Directory ‚Üí App registrations ‚Üí New registration</p>
                        <ul class="text-xs text-gray-500 list-disc list-inside space-y-1">
                            <li>Nombre: <code>BS-Dash-Production</code></li>
                            <li>Supported account types: <code>Accounts in this organizational directory only</code></li>
                            <li>Redirect URI: <code>https://tu-dominio.azurestaticapps.net</code></li>
                        </ul>
                    </div>

                    <div class="guide-step">
                        <h3 class="font-semibold text-gray-800 mb-2">3. Configurar Certificates & Secrets</h3>
                        <p class="text-sm text-gray-600 mb-2">En la aplicaci√≥n creada, ve a Certificates & secrets ‚Üí Client secrets ‚Üí New client secret</p>
                        <ul class="text-xs text-gray-500 list-disc list-inside space-y-1">
                            <li>Description: <code>BS-Dash-Production-Secret</code></li>
                            <li>Expires: <code>24 months (recomendado)</code></li>
                        </ul>
                    </div>

                    <div class="guide-step">
                        <h3 class="font-semibold text-gray-800 mb-2">4. Copiar Configuraci√≥n</h3>
                        <p class="text-sm text-gray-600">Copia los valores y p√©galos en el formulario de la izquierda:</p>
                        <ul class="text-xs text-gray-500 list-disc list-inside space-y-1">
                            <li><strong>Tenant ID:</strong> En Overview ‚Üí Directory (tenant) ID</li>
                            <li><strong>Client ID:</strong> En Overview ‚Üí Application (client) ID</li>
                            <li><strong>Client Secret:</strong> El valor generado (solo visible una vez)</li>
                        </ul>
                    </div>

                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mt-4">
                        <div class="flex items-center gap-2 text-yellow-800">
                            <i class="bi bi-exclamation-triangle"></i>
                            <strong>Importante</strong>
                        </div>
                        <p class="text-sm text-yellow-700 mt-1">
                            Esta configuraci√≥n solo es necesaria cuando despliegues en Azure Static Web Apps. 
                            Mientras est√©s en local, el sistema funciona autom√°ticamente.
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Informaci√≥n del Sistema -->
        <div class="bs-card p-6 mt-6">
            <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                <i class="bi bi-info-circle text-purple-600"></i>
                Informaci√≥n del Sistema
            </h2>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <h3 class="font-semibold text-gray-700 mb-2">Estado Actual</h3>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-600">Modo de Operaci√≥n:</span>
                            <span class="font-medium" id="infoModo">Local</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Autenticaci√≥n:</span>
                            <span class="font-medium" id="infoAuth">Sistema Local</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Base de Datos:</span>
                            <span class="font-medium" id="infoDB">LocalStorage</span>
                        </div>
                    </div>
                </div>

                <div>
                    <h3 class="font-semibold text-gray-700 mb-2">Pr√≥ximos Pasos</h3>
                    <div class="space-y-2 text-sm">
                        <div class="flex items-center gap-2">
                            <i class="bi bi-check-circle text-green-500" id="step1Icon"></i>
                            <span id="step1Text">Configurar Azure AD</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <i class="bi bi-circle text-gray-300" id="step2Icon"></i>
                            <span id="step2Text">Desplegar en Azure Static Web Apps</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <i class="bi bi-circle text-gray-300" id="step3Icon"></i>
                            <span id="step3Text">Migrar datos a Cosmos DB</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Scripts -->
    <script src="../js/config-loader.js"></script>
    <script src="../js/secure-database.js"></script>
    <script src="../js/auth-system.js"></script>
    <script src="../js/database-manager.js"></script>
    <script src="../js/empresa-context.js"></script>
    <script src="../js/file-database.js"></script>
    <script src="../js/auth/microsoft-auth.js"></script>

    <script>
        // ==================== CONFIGURACI√ìN MICROSOFT 365 ====================
        
        let azureConfig = {
            tenantId: '',
            clientId: '', 
            clientSecret: '',
            configured: false,
            lastTest: null
        };

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            console.log('‚öôÔ∏è Iniciando panel de configuraci√≥n Microsoft 365...');
            cargarConfiguracionExistente();
            actualizarEstadoSistema();
            actualizarPasosMigracion();
        });

        // Carga configuraci√≥n existente
        function cargarConfiguracionExistente() {
            try {
                const config = JSON.parse(localStorage.getItem('bs_azure_config') || '{}');
                if (config.tenantId) {
                    document.getElementById('azureTenantId').value = config.tenantId;
                    azureConfig.tenantId = config.tenantId;
                }
                if (config.clientId) {
                    document.getElementById('azureClientId').value = config.clientId;
                    azureConfig.clientId = config.clientId;
                }
                // Client Secret no se carga por seguridad
                
                validarConfiguracion();
                console.log('‚úÖ Configuraci√≥n Azure cargada');
            } catch (error) {
                console.error('Error cargando configuraci√≥n:', error);
            }
        }

        // Valida el formulario
        function validarConfiguracion() {
            const tenantId = document.getElementById('azureTenantId').value;
            const clientId = document.getElementById('azureClientId').value;
            const clientSecret = document.getElementById('azureClientSecret').value;

            const isValid = tenantId && clientId && clientSecret;
            document.getElementById('btnGuardarConfig').disabled = !isValid;

            return isValid;
        }

        // Prueba la conexi√≥n con Azure
        async function probarConexionAzure() {
            if (!validarConfiguracion()) {
                mostrarNotificacion('‚ùå Completa todos los campos primero', 'error');
                return;
            }

            // Simula prueba de conexi√≥n (hasta tener Azure real)
            mostrarNotificacion('üîå Probando conexi√≥n con Azure AD...', 'info');
            
            // Simula delay de conexi√≥n
            await new Promise(resolve => setTimeout(resolve, 2000));

            // Por ahora siempre √©xito en simulaci√≥n
            const exito = Math.random() > 0.2; // 80% de √©xito en simulaci√≥n

            if (exito) {
                mostrarNotificacion('‚úÖ Conexi√≥n con Azure AD probada exitosamente', 'success');
                actualizarEstadoAzure('conectado');
                azureConfig.lastTest = new Date().toISOString();
            } else {
                mostrarNotificacion('‚ùå Error conectando con Azure AD. Verifica la configuraci√≥n.', 'error');
                actualizarEstadoAzure('error');
            }
        }

        // Guarda la configuraci√≥n
        async function guardarConfiguracionAzure() {
            if (!validarConfiguracion()) {
                mostrarNotificacion('‚ùå Configuraci√≥n incompleta', 'error');
                return;
            }

            const config = {
                tenantId: document.getElementById('azureTenantId').value,
                clientId: document.getElementById('azureClientId').value,
                clientSecret: document.getElementById('azureClientSecret').value,
                configuredAt: new Date().toISOString()
            };

            try {
                // Guarda en localStorage
                localStorage.setItem('bs_azure_config', JSON.stringify(config));
                
                // Configura el sistema de autenticaci√≥n
                if (window.microsoftAuth) {
                    window.microsoftAuth.configureAzure(config);
                }

                azureConfig = { ...config, configured: true };
                
                mostrarNotificacion('‚úÖ Configuraci√≥n Azure AD guardada correctamente', 'success');
                actualizarEstadoSistema();
                actualizarPasosMigracion();

                // Limpia el client secret por seguridad
                document.getElementById('azureClientSecret').value = '';

            } catch (error) {
                console.error('Error guardando configuraci√≥n:', error);
                mostrarNotificacion('‚ùå Error guardando configuraci√≥n', 'error');
            }
        }

        // Prueba todas las conexiones
        async function probarTodasConexiones() {
            mostrarNotificacion('üîå Probando todas las conexiones del sistema...', 'info');
            
            // Simula pruebas
            await new Promise(resolve => setTimeout(resolve, 1500));
            
            // Actualiza estados
            actualizarEstadoSistema();
            actualizarPasosMigracion();
            
            mostrarNotificacion('‚úÖ Pruebas de conexi√≥n completadas', 'success');
        }

        // Actualiza el estado visual de Azure
        function actualizarEstadoAzure(estado) {
            const badge = document.getElementById('azureStatusBadge');
            const texto = document.getElementById('estadoAzure');
            
            switch(estado) {
                case 'conectado':
                    badge.innerHTML = '<span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-800">Conectado</span>';
                    texto.textContent = 'Configurado';
                    break;
                case 'error':
                    badge.innerHTML = '<span class="px-2 py-1 text-xs rounded-full bg-red-100 text-red-800">Error</span>';
                    texto.textContent = 'Error';
                    break;
                default:
                    badge.innerHTML = '<span class="px-2 py-1 text-xs rounded-full bg-gray-100 text-gray-800">Inactivo</span>';
                    texto.textContent = 'No Configurado';
            }
        }

        // Actualiza el estado completo del sistema
        function actualizarEstadoSistema() {
            const config = JSON.parse(localStorage.getItem('bs_azure_config') || '{}');
            
            // Azure AD
            if (config.tenantId && config.clientId) {
                actualizarEstadoAzure('conectado');
            } else {
                actualizarEstadoAzure('inactivo');
            }

            // Informaci√≥n del sistema
            document.getElementById('infoModo').textContent = 'Local (Preparado para Azure)';
            document.getElementById('infoAuth').textContent = config.tenantId ? 'Azure AD Configurado' : 'Sistema Local';
            document.getElementById('infoDB').textContent = 'LocalStorage (Cosmos DB listo)';
        }

        // Actualiza los pasos de migraci√≥n
        function actualizarPasosMigracion() {
            const config = JSON.parse(localStorage.getItem('bs_azure_config') || '{}');
            
            // Paso 1: Configurar Azure AD
            if (config.tenantId) {
                document.getElementById('step1Icon').className = 'bi bi-check-circle text-green-500';
                document.getElementById('step1Text').innerHTML = '<strong>Configurar Azure AD</strong> <span class="text-green-600">‚úì Completado</span>';
            }

            // Los otros pasos permanecen pendientes hasta el deploy
        }

        // Sistema de notificaciones
        function mostrarNotificacion(mensaje, tipo = 'info') {
            // Usa tu sistema de notificaciones existente o crea uno simple
            const notification = document.createElement('div');
            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500', 
                info: 'bg-blue-500',
                warning: 'bg-yellow-500'
            };
            
            notification.className = `fixed top-4 right-4 text-white px-6 py-3 rounded-lg shadow-lg z-50 ${colors[tipo]}`;
            notification.textContent = mensaje;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 5000);
        }

        console.log('‚úÖ Panel de configuraci√≥n Microsoft 365 cargado');
    </script>
</body>
</html>