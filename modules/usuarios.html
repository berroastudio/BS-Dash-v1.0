<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BS Dash - Gestión de Usuarios</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #2D0922;
            --bg-secondary: #1a0a15;
            --bg-card: rgba(45, 20, 44, 0.75);
            --bg-hover: rgba(85, 40, 80, 0.8);
            --border-light: rgba(255, 255, 255, 0.15);
            --border-hover: rgba(233, 84, 32, 0.6);
            --text-primary: #FFFFFF;
            --text-secondary: #E8E8E8;
            --text-muted: #AAAAAA;
            --accent-orange: #E95420;
            --accent-purple: #77216F;
            --gradient-primary: linear-gradient(135deg, #E95420, #77216F);
            --gradient-card: linear-gradient(135deg, rgba(65, 25, 60, 0.9), rgba(40, 15, 35, 0.9));
        }

        body {
            font-family: 'Outfit', sans-serif;
            background: linear-gradient(rgba(38, 1, 83, 0.16), rgba(21, 0, 48, 0.046)), 
                        url('https://plus.unsplash.com/premium_photo-1685793804465-b12bbd8b7281?ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&q=80&w=870');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            color: var(--text-primary);
            min-height: 100vh;
        }

        .ubuntu-glass {
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            background: var(--gradient-card);
            border: 1px solid var(--border-light);
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .ubuntu-input {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--border-light);
            border-radius: 12px;
            padding: 12px 16px;
            color: var(--text-primary);
            font-family: 'Outfit', sans-serif;
            transition: all 0.3s ease;
            width: 100%;
        }

        .ubuntu-input:focus {
            outline: none;
            border-color: var(--accent-orange);
            background: rgba(255, 255, 255, 0.15);
            box-shadow: 0 0 0 3px rgba(233, 84, 32, 0.2);
        }

        .ubuntu-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--border-light);
            border-radius: 12px;
            padding: 12px 20px;
            color: var(--text-primary);
            font-family: 'Outfit', sans-serif;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
        }

        .ubuntu-btn:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: var(--border-hover);
            transform: translateY(-2px);
        }

        .ubuntu-btn-primary {
            background: var(--gradient-primary);
            border: none;
            color: white;
        }

        .ubuntu-btn-primary:hover {
            background: linear-gradient(135deg, #77216F, #E95420);
            transform: translateY(-2px);
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-active {
            background: rgba(32, 201, 151, 0.2);
            color: #20C997;
        }

        .status-inactive {
            background: rgba(255, 107, 107, 0.2);
            color: #FF6B6B;
        }

        .role-badge {
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .role-admin {
            background: rgba(220, 53, 69, 0.2);
            color: #DC3545;
        }

        .role-manager {
            background: rgba(253, 126, 20, 0.2);
            color: #FD7E14;
        }

        .role-user {
            background: rgba(32, 201, 151, 0.2);
            color: #20C997;
        }

        .role-viewer {
            background: rgba(108, 117, 125, 0.2);
            color: #6C757D;
        }
    </style>
</head>
<body class="min-h-screen p-6">
    <!-- Header -->
    <div class="ubuntu-glass p-6 mb-6">
        <div class="flex items-center justify-between">
            <div class="flex items-center gap-4">
                <a href="../dashboard.html" class="ubuntu-btn">
                    <i class="bi bi-arrow-left"></i> Volver al Dashboard
                </a>
                <div class="flex items-center gap-3">
                    <div class="w-12 h-12 rounded-xl flex items-center justify-center bg-gradient-to-br from-[#E95420] to-[#77216F]">
                        <i class="bi bi-people text-white text-xl"></i>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold">Gestión de Usuarios</h1>
                        <p class="text-sm text-gray-300">Administra usuarios y permisos del sistema</p>
                    </div>
                </div>
            </div>
            
            <div class="flex items-center gap-4">
                <span class="text-gray-300" id="userName">Cargando...</span>
                <button onclick="logout()" class="ubuntu-btn bg-red-500 bg-opacity-20 text-red-400 border-red-500 border-opacity-30">
                    <i class="bi bi-box-arrow-right"></i> Salir
                </button>
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto">
        <!-- Barra de Herramientas -->
        <div class="ubuntu-glass p-6 mb-6">
            <div class="flex justify-between items-center">
                <h2 class="text-lg font-semibold">Usuarios del Sistema</h2>
                <button onclick="abrirModalUsuario()" class="ubuntu-btn ubuntu-btn-primary">
                    <i class="bi bi-person-plus"></i> Nuevo Usuario
                </button>
            </div>
        </div>

        <!-- Tabla de Usuarios -->
        <div class="ubuntu-glass p-6">
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead>
                        <tr class="border-b border-gray-600">
                            <th class="text-left py-3 px-4 font-semibold">Usuario</th>
                            <th class="text-left py-3 px-4 font-semibold">Email</th>
                            <th class="text-left py-3 px-4 font-semibold">Empresa</th>
                            <th class="text-left py-3 px-4 font-semibold">Rol</th>
                            <th class="text-left py-3 px-4 font-semibold">Estado</th>
                            <th class="text-left py-3 px-4 font-semibold">Último Acceso</th>
                            <th class="text-left py-3 px-4 font-semibold">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="tablaUsuarios">
                        <!-- Los usuarios se cargan dinámicamente -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal Usuario -->
    <div id="modalUsuario" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div class="ubuntu-glass p-6 w-full max-w-md">
            <h3 class="text-xl font-bold mb-4" id="tituloModalUsuario">Nuevo Usuario</h3>
            
            <form id="formUsuario" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Nombre Completo *</label>
                    <input type="text" id="usuarioNombre" class="ubuntu-input w-full" required>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Email *</label>
                    <input type="email" id="usuarioEmail" class="ubuntu-input w-full" required>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Usuario *</label>
                    <input type="text" id="usuarioUsername" class="ubuntu-input w-full" required>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Contraseña *</label>
                    <input type="password" id="usuarioPassword" class="ubuntu-input w-full" required>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Empresa *</label>
                    <select id="usuarioEmpresa" class="ubuntu-input w-full" required>
                        <option value="">Seleccionar empresa...</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Rol *</label>
                    <select id="usuarioRol" class="ubuntu-input w-full" required>
                        <option value="admin">Administrador</option>
                        <option value="gerente">Gerente</option>
                        <option value="vendedor">Vendedor</option>
                        <option value="inventario">Inventario</option>
                        <option value="reportes">Solo Reportes</option>
                    </select>
                </div>

                <div class="flex items-center justify-between p-3 bg-white bg-opacity-5 rounded-lg">
                    <div>
                        <label class="text-gray-300 font-medium">Usuario Activo</label>
                        <p class="text-xs text-gray-400">El usuario puede acceder al sistema</p>
                    </div>
                    <input type="checkbox" id="usuarioActivo" class="ubuntu-checkbox" checked>
                </div>
                
                <div class="flex justify-end gap-3 pt-4">
                    <button type="button" onclick="cerrarModalUsuario()" class="ubuntu-btn">Cancelar</button>
                    <button type="submit" class="ubuntu-btn ubuntu-btn-primary">Guardar Usuario</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Scripts -->
    <script src="../js/config-loader.js"></script>
    <script src="../js/secure-database.js"></script>
    <script src="../js/auth-system.js"></script>
    <script src="../js/database-manager.js"></script>
    <script src="../js/empresa-context.js"></script>
    <script src="../js/supabase-config.js"></script>

    <script>
        class UsuariosManager {
            constructor() {
                this.supabase = window.supabase;
                this.usuarioEditando = null;
                this.init();
            }

            async init() {
                if (!this.verificarAutenticacion()) {
                    return;
                }

                document.getElementById('userName').textContent = this.getUserName();
                await this.cargarEmpresasParaSelect();
                await this.cargarUsuarios();
                this.configurarEventos();
            }

            verificarAutenticacion() {
                const user = localStorage.getItem('bs_dash_user');
                if (!user) {
                    window.location.href = '../index.html';
                    return false;
                }
                return true;
            }

            getUserName() {
                const user = JSON.parse(localStorage.getItem('bs_dash_user') || '{}');
                return user.name || user.email || 'Usuario';
            }

            async cargarUsuarios() {
                try {
                    let usuarios = [];
                    
                    if (this.supabase) {
                        const { data, error } = await this.supabase
                            .from('usuarios')
                            .select('*, empresas(nombre)')
                            .order('nombre');
                            
                        if (error) throw error;
                        usuarios = data;
                    } else {
                        usuarios = JSON.parse(localStorage.getItem('bs_usuarios') || '[]');
                    }

                    this.mostrarUsuarios(usuarios);
                } catch (error) {
                    console.error('Error cargando usuarios:', error);
                    this.mostrarNotificacion('Error cargando usuarios', 'error');
                }
            }

            mostrarUsuarios(usuarios) {
                const tabla = document.getElementById('tablaUsuarios');
                
                if (usuarios.length === 0) {
                    tabla.innerHTML = `
                        <tr>
                            <td colspan="7" class="text-center py-8 text-gray-400">
                                <i class="bi bi-people text-2xl mb-2"></i>
                                <p>No hay usuarios registrados</p>
                            </td>
                        </tr>
                    `;
                    return;
                }

                tabla.innerHTML = usuarios.map(usuario => `
                    <tr class="border-b border-gray-700 hover:bg-white hover:bg-opacity-5">
                        <td class="py-3 px-4">
                            <div class="font-medium">${usuario.nombre}</div>
                            <div class="text-sm text-gray-400">@${usuario.username}</div>
                        </td>
                        <td class="py-3 px-4">${usuario.email}</td>
                        <td class="py-3 px-4">${usuario.empresas?.nombre || 'N/A'}</td>
                        <td class="py-3 px-4">
                            <span class="role-badge ${this.getRoleClass(usuario.rol)}">
                                ${this.getRoleName(usuario.rol)}
                            </span>
                        </td>
                        <td class="py-3 px-4">
                            <span class="status-badge ${usuario.activo ? 'status-active' : 'status-inactive'}">
                                ${usuario.activo ? 'Activo' : 'Inactivo'}
                            </span>
                        </td>
                        <td class="py-3 px-4 text-sm text-gray-400">
                            ${usuario.last_login ? new Date(usuario.last_login).toLocaleDateString() : 'Nunca'}
                        </td>
                        <td class="py-3 px-4">
                            <div class="flex gap-2">
                                <button onclick="usuariosManager.editarUsuario('${usuario.id}')" class="ubuntu-btn text-sm">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                ${usuario.id !== 1 ? `
                                <button onclick="usuariosManager.eliminarUsuario('${usuario.id}')" class="ubuntu-btn bg-red-500 bg-opacity-20 text-red-400 text-sm">
                                    <i class="bi bi-trash"></i>
                                </button>
                                ` : ''}
                            </div>
                        </td>
                    </tr>
                `).join('');
            }

            getRoleClass(rol) {
                const classes = {
                    'admin': 'role-admin',
                    'gerente': 'role-manager', 
                    'vendedor': 'role-user',
                    'inventario': 'role-user',
                    'reportes': 'role-viewer'
                };
                return classes[rol] || 'role-user';
            }

            getRoleName(rol) {
                const names = {
                    'admin': 'Admin',
                    'gerente': 'Gerente',
                    'vendedor': 'Vendedor',
                    'inventario': 'Inventario',
                    'reportes': 'Reportes'
                };
                return names[rol] || rol;
            }

            async cargarEmpresasParaSelect() {
                try {
                    let empresas = [];
                    
                    if (this.supabase) {
                        const { data } = await this.supabase
                            .from('empresas')
                            .select('id, nombre')
                            .order('nombre');
                        empresas = data || [];
                    } else {
                        empresas = JSON.parse(localStorage.getItem('bs_empresas') || '[]');
                    }

                    const select = document.getElementById('usuarioEmpresa');
                    select.innerHTML = '<option value="">Seleccionar empresa...</option>' +
                        empresas.map(empresa => 
                            `<option value="${empresa.id}">${empresa.nombre}</option>`
                        ).join('');
                } catch (error) {
                    console.error('Error cargando empresas para select:', error);
                }
            }

            abrirModalUsuario(usuarioId = null) {
                this.usuarioEditando = usuarioId;
                const modal = document.getElementById('modalUsuario');
                const titulo = document.getElementById('tituloModalUsuario');
                
                if (usuarioId) {
                    titulo.textContent = 'Editar Usuario';
                    this.cargarDatosUsuario(usuarioId);
                } else {
                    titulo.textContent = 'Nuevo Usuario';
                    document.getElementById('formUsuario').reset();
                    document.getElementById('usuarioActivo').checked = true;
                }
                
                modal.classList.remove('hidden');
                modal.classList.add('flex');
            }

            cerrarModalUsuario() {
                const modal = document.getElementById('modalUsuario');
                modal.classList.add('hidden');
                modal.classList.remove('flex');
                this.usuarioEditando = null;
            }

            async cargarDatosUsuario(usuarioId) {
                try {
                    let usuario = null;
                    
                    if (this.supabase) {
                        const { data, error } = await this.supabase
                            .from('usuarios')
                            .select('*')
                            .eq('id', usuarioId)
                            .single();
                            
                        if (error) throw error;
                        usuario = data;
                    } else {
                        const usuarios = JSON.parse(localStorage.getItem('bs_usuarios') || '[]');
                        usuario = usuarios.find(u => u.id == usuarioId);
                    }

                    if (usuario) {
                        document.getElementById('usuarioNombre').value = usuario.nombre || '';
                        document.getElementById('usuarioEmail').value = usuario.email || '';
                        document.getElementById('usuarioUsername').value = usuario.username || '';
                        document.getElementById('usuarioEmpresa').value = usuario.empresa_id || '';
                        document.getElementById('usuarioRol').value = usuario.rol || 'vendedor';
                        document.getElementById('usuarioActivo').checked = usuario.activo !== false;
                        
                        // No cargar la contraseña por seguridad
                        document.getElementById('usuarioPassword').required = false;
                    }
                } catch (error) {
                    console.error('Error cargando datos de usuario:', error);
                    this.mostrarNotificacion('Error cargando datos de usuario', 'error');
                }
            }

            async guardarUsuario(datos) {
                try {
                    if (this.supabase) {
                        if (this.usuarioEditando) {
                            const { error } = await this.supabase
                                .from('usuarios')
                                .update(datos)
                                .eq('id', this.usuarioEditando);
                                
                            if (error) throw error;
                        } else {
                            const { error } = await this.supabase
                                .from('usuarios')
                                .insert([datos]);
                                
                            if (error) throw error;
                        }
                    } else {
                        let usuarios = JSON.parse(localStorage.getItem('bs_usuarios') || '[]');
                        
                        if (this.usuarioEditando) {
                            const index = usuarios.findIndex(u => u.id == this.usuarioEditando);
                            if (index !== -1) {
                                usuarios[index] = { ...usuarios[index], ...datos };
                            }
                        } else {
                            datos.id = Date.now().toString();
                            datos.fecha_creacion = new Date().toISOString();
                            usuarios.push(datos);
                        }
                        
                        localStorage.setItem('bs_usuarios', JSON.stringify(usuarios));
                    }
                    
                    this.mostrarNotificacion('✅ Usuario guardado correctamente', 'success');
                    this.cerrarModalUsuario();
                    await this.cargarUsuarios();
                } catch (error) {
                    console.error('Error guardando usuario:', error);
                    this.mostrarNotificacion('Error guardando usuario', 'error');
                }
            }

            async eliminarUsuario(usuarioId) {
                if (!confirm('¿Estás seguro de que deseas eliminar este usuario? Esta acción no se puede deshacer.')) {
                    return;
                }

                try {
                    if (this.supabase) {
                        const { error } = await this.supabase
                            .from('usuarios')
                            .delete()
                            .eq('id', usuarioId);
                            
                        if (error) throw error;
                    } else {
                        let usuarios = JSON.parse(localStorage.getItem('bs_usuarios') || '[]');
                        usuarios = usuarios.filter(u => u.id != usuarioId);
                        localStorage.setItem('bs_usuarios', JSON.stringify(usuarios));
                    }
                    
                    this.mostrarNotificacion('✅ Usuario eliminado correctamente', 'success');
                    await this.cargarUsuarios();
                } catch (error) {
                    console.error('Error eliminando usuario:', error);
                    this.mostrarNotificacion('Error eliminando usuario', 'error');
                }
            }

            configurarEventos() {
                document.getElementById('formUsuario').addEventListener('submit', (e) => {
                    e.preventDefault();
                    
                    const datos = {
                        nombre: document.getElementById('usuarioNombre').value,
                        email: document.getElementById('usuarioEmail').value,
                        username: document.getElementById('usuarioUsername').value,
                        empresa_id: document.getElementById('usuarioEmpresa').value,
                        rol: document.getElementById('usuarioRol').value,
                        activo: document.getElementById('usuarioActivo').checked,
                        updated_at: new Date().toISOString()
                    };

                    // Solo incluir password si se está creando un nuevo usuario o se cambió
                    if (!this.usuarioEditando || document.getElementById('usuarioPassword').value) {
                        datos.password_hash = btoa(document.getElementById('usuarioPassword').value); // Simulación de hash
                    }

                    if (!datos.nombre || !datos.email || !datos.username) {
                        this.mostrarNotificacion('❌ Nombre, email y usuario son requeridos', 'error');
                        return;
                    }

                    this.guardarUsuario(datos);
                });
            }

            mostrarNotificacion(mensaje, tipo = 'info') {
                const notificacion = document.createElement('div');
                
                const colors = {
                    success: '#10B981',
                    error: '#EF4444',
                    info: '#3B82F6'
                };
                
                const icons = {
                    success: 'bi-check-circle',
                    error: 'bi-exclamation-triangle',
                    info: 'bi-info-circle'
                };
                
                notificacion.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <i class="bi ${icons[tipo]}" style="color: ${colors[tipo]}; font-size: 18px;"></i>
                        <span>${mensaje}</span>
                    </div>
                `;
                
                Object.assign(notificacion.style, {
                    position: 'fixed',
                    top: '20px',
                    right: '20px',
                    background: 'rgba(51, 51, 51, 0.9)',
                    backdropFilter: 'blur(20px)',
                    border: '1px solid rgba(255,255,255,0.2)',
                    borderRadius: '12px',
                    padding: '15px 20px',
                    color: 'white',
                    zIndex: '10000',
                    boxShadow: '0 8px 32px rgba(0,0,0,0.4)',
                    animation: 'slideInRight 0.3s ease',
                    fontFamily: 'Outfit, sans-serif'
                });
                
                document.body.appendChild(notificacion);
                
                setTimeout(() => {
                    notificacion.style.opacity = '0';
                    notificacion.style.transition = 'opacity 0.5s ease';
                    setTimeout(() => notificacion.remove(), 500);
                }, 4000);
            }
        }

        // Inicialización
        let usuariosManager;

        document.addEventListener('DOMContentLoaded', function() {
            usuariosManager = new UsuariosManager();
        });

        // Funciones globales
        function abrirModalUsuario() {
            usuariosManager.abrirModalUsuario();
        }

        function cerrarModalUsuario() {
            usuariosManager.cerrarModalUsuario();
        }

        function logout() {
            if (confirm("¿Estás seguro de que deseas cerrar sesión?")) {
                localStorage.clear();
                window.location.href = '../index.html';
            }
        }

        // Agregar keyframes y estilos
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideInRight {
                from {
                    opacity: 0;
                    transform: translateX(100%);
                }
                to {
                    opacity: 1;
                    transform: translateX(0);
                }
            }
            
            .ubuntu-checkbox {
                width: 20px;
                height: 20px;
                border-radius: 6px;
                border: 2px solid var(--border-light);
                background: rgba(255, 255, 255, 0.1);
                cursor: pointer;
                transition: all 0.3s ease;
                appearance: none;
                position: relative;
            }
            
            .ubuntu-checkbox:checked {
                background: var(--accent-orange);
                border-color: var(--accent-orange);
            }
            
            .ubuntu-checkbox:checked::after {
                content: '✓';
                position: absolute;
                color: white;
                font-size: 14px;
                font-weight: bold;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>